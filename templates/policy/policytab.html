{% extends "dashboard/base.html" %}
{% load static %}
{% block main-content %}
<style>
    
    #carrier-summary {
        width: 300px;
        background: #fff;
        padding: 15px;
        border-left: 1px solid #ddd;
        position: fixed;
        right: -300px; 
        top: 50px; 
        height: calc(100vh - 50px);
        overflow-y: auto;
        z-index: 1000;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
    }

    #carrier-summary.shown {
        right: 0;
    }

    .main-content-wrapper {
        transition: all 0.3s ease;
        padding-right: 0;
        min-height: calc(100vh - 120px);
    }

    .main-content-wrapper.sidebar-shown {
        padding-right: 300px;
    }

    .summary-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .summary-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f5f5f5;
    }

    .action-buttons {
        position: fixed;
        right: 20px;
        top: 80px;
        z-index: 1010;
    }

    .close-sidebar {
        position: absolute;
        right: 15px;
        top: 15px;
        cursor: pointer;
        color: #999;
    }

    .close-sidebar:hover {
        color: #333;
    }

    .summary-group {
        position: relative;
    }

    .summary-group .hover-label {
        position: absolute;
        top: 100%;
        left: 0;
        white-space: nowrap;
        background: #fff;
        padding: 2px 8px;
        border: 1px solid #ccc;
        font-size: 12px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: none;
        z-index: 10;
        margin-top: 2px;
    }

    .summary-group button:hover + .hover-label {
        display: block;
    }

    /* Responsive adjustments for sidebar */
    @media (max-width: 1199px) {
        #carrier-summary {
            width: 280px;
            right: -280px;
        }
        
        .main-content-wrapper.sidebar-shown {
            padding-right: 280px;
        }
    }

    @media (max-width: 991px) {
        .action-buttons {
            right: 15px;
            top: 55px;
        }
    }

    @media (max-width: 768px) {
        #carrier-summary {
            width: 250px;
            right: -250px;
        }
        
        .main-content-wrapper.sidebar-shown {
            padding-right: 250px;
        }
        
        .action-buttons {
            top: 50px;
        }
    }

    @media (max-width: 576px) {
        #carrier-summary {
            width: 100%;
            right: -100%;
        }
        
        .main-content-wrapper.sidebar-shown {
            padding-right: 0;
            transform: translateX(-100%);
        }
        
        .action-buttons {
            position: relative;
            right: auto;
            top: auto;
            margin-bottom: 15px;
            text-align: right;
        }
    }

    /* Rest of your existing styles remain unchanged */
    .checkbox-container {
        border: 1px solid #ced4da;
        border-radius: .25rem;
        max-height: 120px;
        overflow-y: auto;
        padding: 5px;
        width: 100%;
    }

    .checkbox-item {
        padding: 3px 0;
        margin: 0;
    }

    .checkbox-item input[type="checkbox"] {
        margin: 0 5px 0 0;
        vertical-align: middle;
    }

    .checkbox-item label {
        margin: 0;
        display: inline;
        font-size: 12px;
    }

  
    .dollar-input-wrapper {
        position: relative;
    }

    .dollar-input {
        padding-left: 1.5rem;
    }

    .dollar-input-wrapper::before {
        content: "$";
        position: absolute;
        top: 50%;
        left: 10px;
        transform: translateY(-50%);
        color: #495057;
        font-size: 14px;
        pointer-events: none;
    }

    
    .agent-info-container,
    .custom-fields-panel {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    
    .agent-info-container:last-of-type,
    .custom-fields-panel:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

   
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

   
    .custom-fields-edit .btn {
        white-space: nowrap;
    }

    .section-title {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        font-size: 1.75rem;
        color: #222222;
        letter-spacing: 0.05em;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 8px;
        text-transform: capitalize;
    }

    .page-header-row {
        display: flex;
        align-items: center;
        white-space: nowrap;
        gap: 15px;
        margin-bottom: 35px;
    }

    .page-title {
        margin: 0;
        font-size: 26px;
        font-weight: bold;
    }

    .clickable-name {
        text-decoration: underline;
        cursor: pointer;
        color: #000000;
    }

    .clickable-name:hover {
        color: #092248;
    }

    .wellcare-link {
        color: #0d6efd;
        text-decoration: underline;
        font-size: 16px;
    }

    .wellcare-color {
        width: 14px;
        height: 14px;
        background-color: #b26fd7;
        border-radius: 3px;
        display: inline-block;
        margin-right: 5px;
    }

    .PDP-color {
        width: 14px;
        height: 14px;
        background-color: #2fa00c;
        border-radius: 3px;
        display: inline-block;
        margin-right: 5px;
    }

    .PDP-link {
        color: #000000;
        text-decoration: underline;
        font-size: 16px;
    }

    .wellcare-tag {
        display: flex;
        align-items: center;
        margin-left: 5px;
    }

    
    @media (max-width: 768px) {
        .page-header-row {
            flex-wrap: wrap;
            white-space: normal;
        }

        .nav-tabs-container {
            overflow-x: auto;
            white-space: nowrap;
            flex-wrap: nowrap;
            display: flex;
        }

        .nav-tab-btn-group {
            margin-bottom: 10px;
        }
    }

    .client-info-section {
        display: none;
    }

    .active-section {
        display: block;
    }

    .modal-footer-responsive {
        padding: 15px;
        overflow-x: auto;
    }

    .btn-group-custom {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
        justify-content: center;
    }

    .curved-btn {
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        white-space: nowrap;
        min-width: 120px;
    }

    @media (max-width: 768px) {
        .btn-group-custom {
            flex-direction: column;
            gap: 6px;
        }

        .curved-btn {
            width: 100%;
            margin: 2px 0 !important;
        }
    }

    .step-indicator {
        display: flex;
        align-items: center;
    }

    .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background-color: #07408b;
        color: white;
        border-radius: 50%;
        font-weight: bold;
        margin-right: 10px;
    }

    .step-title {
        font-weight: bold;
    }

    .text-danger {
        color: #d9534f;
    }
</style>


<div class="action-buttons">
  <div class="btn-group summary-group position-relative">
   
    <button id="toggle-carrier-summary" class="btn btn-default btn-sm">
      <i class="fa fa-list-alt"></i>
    </button>
    <div class="hover-label">Summary</div>


    <button class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
      <span class="caret"></span>
    </button>
    <div class="hover-label">Action</div>

    
    <ul class="dropdown-menu dropdown-menu-right">
      <li><a href="#"><i class="fa fa-print"></i> Print Record</a></li>
      <li class="divider"></li>
      <li><a href="#"><i class="fa fa-cog"></i> Print Page</a></li>
    </ul>
  </div>
</div>


<div class="main-content-wrapper">
    <div class="container-default">
        <div class="content-wrapper">
            <div class="search-agents-container">
                
                <div class="page-header-row clearfix" style="margin-bottom: 20px;">

                    <div style="float: left;">
                        <h1 class="page-title" style="margin: 0;"><a href="#"
                                class="clickable-name">{{policy.individual.first_name}} {{policy.individual.middle_name}}
                                {{policy.individual.last_name}}</a></h1>
                    </div>
                    <div style="float: left; margin-left: 15px; display: flex; align-items: center; gap: 10px;">
                        <button type="button" class="btn btn-sm btn-default" data-toggle="modal" data-target="#editModal" data-policy-id="{{ policy.id }}"
        data-individual-id="{{ policy.individual.id }}"
        data-individual-name="{{ policy.individual.first_name }} {{ policy.individual.middle_name }} {{ policy.individual.last_name }}">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                        <div class="wellcare-tag" style="margin: 0;">
                            <span class="wellcare-color"></span>
                            <a href="{% url 'carrier_detail' policy.carrier.id %}"
                                class="wellcare-link">{{policy.carrier.name}}</a>
                        </div>
                        <div class="PDP-tag" style="margin: 0;">
                            <span class="PDP-color"></span>
                            <span class="PDP-link">{{policy.policy_number|default:"(not set)"}}
                                {{policy.coverage_type}}</span>
                        </div>
                    </div>
                </div>


               
                <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">

                    <div class="modal-dialog modal-md" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h2 class="modal-title" id="newPolicyModalLabel">Change Policyholder</h2>
                            </div>
                        <form id="policyForm" method="post" action="{% url 'update_policy' %}">
                            {% csrf_token %}
                            <input type="hidden" name="policy_id" id="policyId">
                            <div class="modal-body">
                                
                                    <div class="step-container">
                                        <!-- Step 1: Client Info -->
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <p class="text-muted" style="margin: 10px 0 0 0; font-size: 12px;">
                                                    Fields marked with an <span class="text-danger">*</span> are required
                                                </p>

                                            </div>
                                            <div class="panel-body client-info-section active-section">
                                                <div class="form-group">
                                                    <label for="recordType">Select Record Type</label>
                                                    <select id="recordType" name="record_type" class="form-control" required>
                                                        <option value="">-- Select --</option>
                                                        <option value="existing">Existing Individual</option>
                                                        <option value="new">New Individual</option>
                                                    </select>
                                                </div>

                                                <!-- Existing Individual Fields -->
                                                <div id="existingIndividualFields" style="display: none;">
                                                    <label for="existingClientSearch">Search Existing Individual:</label>
                                                    <input type="text" id="existingClientSearch" placeholder="Type a name..."
                                                        autocomplete="off">
                                                    <input type="hidden" name="individual_id" id="individualId">
                                                    <div id="individualSuggestions" class="list-group position-absolute w-100"
                                                        style="z-index: 1000;"></div>
                                                </div>
                                                <!-- New Individual Fields -->
                                                <div id="newIndividualFields" style="display:none;">
                                                    <div class="row">
                                            <div class="form-group col-md-4">
                                                <label for="firstName">First Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="firstName" name="first_name"
                                                    placeholder="First Name">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="middleName">Middle Name</label>
                                                <input type="text" class="form-control" id="middleName" name="middle_name"
                                                    placeholder="Middle Name">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="lastName">Last Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="lastName" name="last_name"
                                                    placeholder="Last Name">
                                            </div>
                                                </div>

                                      <div class="row">
    <div class="form-group col-md-4">
        <label for="clientType">Type</label>
        <select id="clientType" name="individual_type" class="form-control">
            <option value="">Select Type</option>
            <option value="Prospect">Prospect</option>
            <option value="Client">Client</option>
            <option value="Ex-Prospect">Ex-Prospect</option>
            <option value="Ex-Client">Ex-Client</option>
            <option value="Contact">Contact</option>
        </select>
    </div>
    <div class="form-group col-md-4">
        <label for="servicingAgent">Servicing Agent</label>
        <input type="text" class="form-control agent-autocomplete" id="servicing_agent" autocomplete="off">
        <input type="hidden" id="servicing_agent_id" name="servicing_agent_id">
        <div id="servicingSuggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
    </div>
    <div class="form-group col-md-4">
        <label for="email">Email</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Enter email">
    </div>
</div>


                                        <!-- Vertically Stacked Phone Fields -->
                                        <div class="row">
                                            <div class="form-group col-md-12">
                                                <label for="businessPhone">Business Phone/Ext</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="businessPhone"
                                                        name="business_phone" placeholder="Phone">
                                                    <span class="input-group-addon">ext</span>
                                                    <input type="text" class="form-control" id="businessExt"
                                                        name="business_ext" placeholder="Ext">
                                                </div>
                                            </div>

                                            <div class="form-group col-md-12">
                                                <label for="homePhone">Home Phone/Ext</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="homePhone" name="home_phone"
                                                        placeholder="Phone">
                                                    <span class="input-group-addon">ext</span>
                                                    <input type="text" class="form-control" id="homeExt" name="home_ext"
                                                        placeholder="Ext">
                                                </div>
                                            </div>

                                            <div class="form-group col-md-12">
                                                <label for="cellPhone">Cell Phone/Ext</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="cellPhone" name="cell_phone"
                                                        placeholder="Phone">
                                                    <span class="input-group-addon">ext</span>
                                                    <input type="text" class="form-control" id="cellExt" name="cell_ext"
                                                        placeholder="Ext">
                                                </div>
                                            </div>
                                        </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                            </div>

                            <div class="modal-footer modal-footer-responsive justify-content-center text-center">
                                <div class="btn-group-custom">
                                    <button type="submit" class="btn btn-success curved-btn" form="policyForm">Save</button>
                                    <button type="button" class="btn btn-default curved-btn"
                                        data-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>


                </div>

                <!-- Tab Navigation -->
                <div class="nav-tabs-container d-flex flex-wrap">
                    <!-- Detail Tab -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#detail-policy" class="btn btn-secondary nav-tab-btn active" data-toggle="tab">Detail</a>
                    </div>

                    <!-- Coverage Tab -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#Coverage-policy" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Coverage</a>
                    </div>

                    <!-- Activities Tab -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#Activities-policy" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Activities</a>
                    </div>

                    <!-- Notes Tab -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#Notes-policy" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Notes</a>
                    </div>

                    <!-- WorkFlow Dropdown -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <button type="button" class="btn btn-secondary nav-tab-btn dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            WorkFlow ▼
                        </button>
                        <ul class="dropdown-menu shadow p-2 border-0">
                            <li><a class="dropdown-item py-2" href="#workflow-action" data-toggle="tab">Triggered Action</a>
                            </li>
                            <li><a class="dropdown-item py-2" href="#workflow-detail" data-toggle="tab">Triggered
                                    Workflow</a></li>
                        </ul>
                    </div>

                    <!-- Email Dropdown -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <button type="button" class="btn btn-secondary nav-tab-btn dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Email ▼
                        </button>
                        <ul class="dropdown-menu shadow p-2 border-0">
                            <li><a class="dropdown-item py-2" href="#incoming-email" data-toggle="tab">Incoming Emails</a>
                            </li>
                            <li><a class="dropdown-item py-2" href="#outgoing-email" data-toggle="tab">Outcoming Emails</a>
                            </li>
                            <li><a class="dropdown-item py-2" href="#Campaigns" data-toggle="tab">Campaigns</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Tab Content Sections -->
                <div class="tab-content">
                    <!-- Detail Tab -->
                    <div class="tab-pane active" id="detail-policy">
                        {% include "policy/policydetails.html" %}
                    </div>

                    <!-- Coverage Tab -->
                    <div class="tab-pane" id="Coverage-policy">
                        {% include "policy/policycoverage.html" %}
                    </div>


                    <!-- Other Tabs -->
                    <div class="tab-pane" id="Activities-policy">
                        {% include "policy/policyactivities.html" %}
                    </div>
                    <div class="tab-pane" id="Notes-policy">
                        {% include "policy/policynotes.html" %}
                    </div>
                    <div class="tab-pane" id="workflow-action">
                        {% include "policy/policyworkflowaction.html" %}
                    </div>
                    <div class="tab-pane" id="workflow-detail">
                        {% include "policy/policyworkflowdetail.html" %}
                    </div>
                    <div class="tab-pane" id="incoming-email">
                        {% include "policy/policyinemails.html" %}
                    </div>
                    <div class="tab-pane" id="outgoing-email">
                        {% include "policy/policyoutemails.html" %}
                    </div>
                    <div class="tab-pane" id="Campaigns">
                        {% include "policy/policycampaigns.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Carrier Summary Sidebar -->
<div id="carrier-summary">
    <span class="close-sidebar" id="close-sidebar">&times;</span>
    
    <div class="summary-header">
        <h3><i class="fa fa-building-o"></i> Policy Summary</h3>
    </div>
   
    <div class="summary-item">
        <h4><i class="fa fa-calendar"></i> Dates</h4>

        <div class="d-flex justify-content-between">
            <span>App Submit Date</span>
            <span class="text-muted">—</span>
        </div>

        <div class="d-flex justify-content-between">
            <span>Effective Date —</span>
            <span>01/01/2024</span>
        </div>

        <div class="d-flex justify-content-between">
            <span>Renewal Date</span>
            <span class="text-muted">—</span>
        </div>

        <div class="d-flex justify-content-between">
            <span>Term Date</span>
            <span class="text-muted">—</span>
        </div>
    </div>

    <div class="summary-item">
        <h4><i class="fa fa-tasks"></i> Activities Due</h4>
        <p class="text-muted">No activities.</p>
        <a href="#" class="btn btn-xs btn-success" data-toggle="modal" data-target="#carrieractivityModal">
            <i class="fa fa-plus"></i> Create new
        </a>
    </div>
    
    <div class="summary-item">
        <h4><i class="fa fa-thumb-tack"></i> Pinned Note</h4>
        <p class="text-muted">No pinned note.</p>
        <a href="#Notes-policy" class="btn btn-xs btn-info" id="create-pinnednote-from-sidebar">
            <i class="fa fa-plus"></i> Create new
        </a>
    </div>
</div>

<!-- Modal -->
{% include "carrier/carrieractivitymodal.html" %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script>
    $(document).ready(function() {
        // Handle Create New Pinned Note from sidebar
        $('#create-pinnednote-from-sidebar').click(function(e) {
            e.preventDefault();
            
            // Show the Notes tab if not already active
            if (!$('#Notes-policy').hasClass('active')) {
                $('a[href="#Notes-policy"]').tab('show');
            }
            
            // Directly show the note form container
            $('#createNewnoteContainer').show();
            
            // Hide the main content
            $('#notesMainContent').hide();
            
            // Check the "Pin Note" checkbox by default
            $('#noteForm input[name="pin_note"]').prop('checked', true);
            
            // Scroll to the form for better UX
            $('html, body').animate({
                scrollTop: $('#createNewnoteContainer').offset().top - 20
            }, 300);
        });

        // Existing note creation functionality
        $('#showCreateNoteBtn').click(function(e) {
            e.preventDefault();
            $('#notesMainContent').hide();
            $('#createNewnoteContainer').show();
            $('#noteForm input[name="pin_note"]').prop('checked', false);
            $('html, body').animate({
                scrollTop: $('#createNewnoteContainer').offset().top - 20
            }, 300);
        });

        // Back/Cancel buttons
        $('#backToNotesBtn, #cancelNoteBtn').click(function(e) {
            e.preventDefault();
            $('#createNewnoteContainer').hide();
            $('#notesMainContent').show();
            $('#noteForm')[0].reset();
        });

        // Form submission
        $('#noteForm').submit(function(e) {
            e.preventDefault();
            
            // Here you would typically submit the form via AJAX
            // For demonstration, we'll simulate a successful submission
            alert('Note saved successfully!');
            $('#createNewnoteContainer').hide();
            $('#notesMainContent').show();
            this.reset();
            location.reload();
        });
    });
    
    // Sidebar toggle functionality
    $(document).ready(function() {
        $('#toggle-carrier-summary').click(function(e) {
            e.preventDefault();
            $('#carrier-summary').toggleClass('shown');
            $('.main-content-wrapper').toggleClass('sidebar-shown');

            if ($(window).width() <= 576) {
                $('body').css('overflow-x', $('#carrier-summary').hasClass('shown') ? 'hidden' : 'auto');
            }
        });

        $('#close-sidebar').click(function(e) {
            e.preventDefault();
            $('#carrier-summary').removeClass('shown');
            $('.main-content-wrapper').removeClass('sidebar-shown');
            if ($(window).width() <= 576) {
                $('body').css('overflow-x', 'auto');
            }
        });

        $(document).click(function(e) {
            if ($(window).width() <= 576 && $('#carrier-summary').hasClass('shown')) {
                if (!$(e.target).closest('#carrier-summary').length &&
                    !$(e.target).closest('#toggle-carrier-summary').length) {
                    $('#carrier-summary').removeClass('shown');
                    $('.main-content-wrapper').removeClass('sidebar-shown');
                    $('body').css('overflow-x', 'auto');
                }
            }
        });
    });

    // Rest of your existing JavaScript remains unchanged
    $(document).ready(function () {
        // --- Toggle between new/existing individual fields ---
        function toggleNewIndividualFields() {
            const selectedType = $('#recordType').val();
            if (selectedType === 'new') {
                $('#newIndividualFields').slideDown(200);
                $('#existingIndividualFields').slideUp(200);
            } else if (selectedType === 'existing') {
                $('#existingIndividualFields').slideDown(200);
                $('#newIndividualFields').slideUp(200);
            } else {
                $('#existingIndividualFields, #newIndividualFields').slideUp(200);
            }
        }

        $('#recordType').on('change', toggleNewIndividualFields);

        // --- When Edit Modal Opens ---
        $('#editModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const policyId = button.data('policy-id');
            const individualId = button.data('individual-id');
            const individualName = button.data('individual-name');

            $('#policyForm')[0].reset();
            $('#recordType').val('');
            $('#existingIndividualFields, #newIndividualFields').hide();
            $('#policyId').val(policyId);
            $('#individualId').val('');
            $('#existingClientSearch').val('');

            if (individualId && individualName) {
                $('#recordType').val('existing');
                $('#existingClientSearch').val(individualName);
                $('#individualId').val(individualId);
                $('#existingIndividualFields').show();
            }

            $('.client-info-section').addClass('active-section');
        });

        // --- Individual Autocomplete ---
        $("#existingClientSearch").on("input", function () {
            let query = $(this).val();
            if (query.length >= 2) {
                $.ajax({
                    url: "/individuals/search/relationship/",
                    data: { term: query },
                    success: function (data) {
                        let suggestions = "";
                        if (data.length === 0) {
                            suggestions = '<a href="#" class="list-group-item disabled">No results</a>';
                        } else {
                            data.forEach(individual => {
                                suggestions += `<a href="#" class="list-group-item" data-id="${individual.id}" data-label="${individual.label}">${individual.label}</a>`;
                            });
                        }
                        $("#individualSuggestions").html(suggestions).show();
                    }
                });
            } else {
                $("#individualSuggestions").empty().hide();
            }
        });

        $(document).on("click", "#individualSuggestions a", function (e) {
            e.preventDefault();
            const name = $(this).data("label");
            const id = $(this).data("id");
            $("#existingClientSearch").val(name);
            $("#individualId").val(id);
            $("#individualSuggestions").empty().hide();
        });

        $("#existingClientSearch").on("blur", function () {
            setTimeout(() => {
                $("#individualSuggestions").fadeOut();
            }, 150);
        });

        // --- Agent Autocomplete ---
        $("#servicing_agent").on("input", function () {
            let query = $(this).val();
            if (query.length >= 2) {
                $.ajax({
                    url: "/agents/search/",
                    data: { term: query },
                    success: function (data) {
                        let suggestions = "";
                        if (data.length === 0) {
                            suggestions = '<a href="#" class="list-group-item list-group-item-action disabled">No results found</a>';
                        } else {
                            data.forEach(agent => {
                                suggestions += `<a href="#" class="list-group-item list-group-item-action" data-id="${agent.id}" data-label="${agent.label}">${agent.label}</a>`;
                            });
                        }
                        $("#servicingSuggestions").html(suggestions).show();
                    }
                });
            } else {
                $("#servicingSuggestions").empty().hide();
            }
        });

        $(document).on("click", "#servicingSuggestions a", function (e) {
            e.preventDefault();
            const name = $(this).data("label");
            const id = $(this).data("id");
            $("#servicing_agent").val(name);
            $("#servicing_agent_id").val(id);
            $("#servicingSuggestions").empty().hide();
        });

        $("#servicing_agent").on("blur", function () {
            setTimeout(() => {
                $("#servicingSuggestions").fadeOut();
            }, 150);
        });

        // --- Form Submission Validation ---
        $('#policyForm').on('submit', function (e) {
            const recordType = $('#recordType').val();

            if (recordType === 'existing') {
                if (!$('#individualId').val()) {
                    e.preventDefault();
                    alert('Please select an existing individual.');
                    return;
                }
            } else if (recordType === 'new') {
                // Clear the hidden individualId so it doesn't interfere
                $('#individualId').val('');
            }
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const phoneFields = document.querySelectorAll('input[name$="_phone"]');

        phoneFields.forEach(function (field) {
            const warning = document.createElement('small');
            warning.style.color = 'red';
            warning.style.display = 'none';
            warning.textContent = 'Phone number must be exactly 10 digits.';
            field.parentElement.appendChild(warning);

            field.addEventListener('input', function () {
                const digitsOnly = field.value.replace(/\D/g, '');
                warning.style.display = (digitsOnly.length > 0 && digitsOnly.length !== 10) ? 'block' : 'none';
            });
            phoneFields.forEach(function (field) {
                field.addEventListener('keypress', function (e) {
                    const char = String.fromCharCode(e.which);
                    if (!/[0-9]/.test(char)) {
                        e.preventDefault();
                    }
                });
            });
        });
    });
</script>

{% endblock %}