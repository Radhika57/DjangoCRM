{% extends "dashboard/base.html" %}
{% load static %}

{% block main-content %}
<style>
    .commission-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 20px auto;
        max-width: 1200px;
    }
    .header-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .section-divider {
        border-top: 1px solid #dee2e6;
        margin: 25px 0;
    }
    .timeframe-section {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        border: 1px solid #dee2e6;
    }
    .timeframe-options {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
    }
    .info-section {
        background: #e9f7ef;
        border-left: 4px solid #28a745;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 4px 4px 0;
    }
    .form-section {
        margin: 25px 0;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .badge-recommended {
        background: #28a745;
        font-size: 0.75em;
        margin-left: 8px;
    }
    .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 15px;
    }
    select[multiple] {
        min-height: 120px;
    }
    .report-options {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .date-range-container {
        display: flex;
        align-items: center;
    }
    .date-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .date-input {
        width: 140px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .date-separator {
        color: #6c757d;
        font-size: 0.875rem;
        padding: 0 5px;
    }
    .checkbox-container {
        border: 1px solid #ced4da;
        border-radius: .25rem;
        max-height: 120px;
        overflow-y: auto;
        padding: 5px;
    }
    .checkbox-item {
        padding: 3px 0;
        margin: 0;
    }
    .checkbox-item input[type="checkbox"] {
        margin-right: 5px;
    }
    
    /* Media Queries */
    @media (max-width: 768px) {
        .commission-container {
            padding: 15px;
        }
        .timeframe-options {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
        .report-options {
            flex-direction: column;
            gap: 10px;
        }
        .action-buttons {
            flex-direction: column;
            gap: 10px;
        }
        .date-input-group {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        .date-separator {
            display: none;
        }
    }
    .checkbox-container {
        border: 1px solid #ced4da;
        border-radius: .25rem;
        max-height: 120px;
        overflow-y: auto;
        padding: 5px;
        width: 100%;
    }

    .checkbox-item {
        padding: 3px 0;
        margin: 0;
    }

    .checkbox-item input[type="checkbox"] {
        margin: 0 5px 0 0;
        vertical-align: middle;
    }

    .checkbox-item label {
        margin: 0;
        display: inline;
        font-size: 12px;
    }

    .compact-section {
        margin-bottom: 15px;
    }
</style>

<div class="commission-container">
    <!-- Header Section -->
    <div class="header-section">
        <small class="text-muted">STANDARD REPORTS / COMMISSION</small>
        <h3>Commission Not Received</h3>
    </div>

    <!-- Timeframe Selection -->
    <div class="timeframe-section">
        <h5 class="section-title">Report Timeframe</h5>
        <div class="timeframe-options">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="timeframe" id="billFromDate" checked>
                <label class="form-check-label" for="billFromDate">
                    Bill From Date <span class="badge badge-recommended">RECOMMENDED</span>
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="timeframe" id="agentStatementDate">
                <label class="form-check-label" for="agentStatementDate">Agent Statement Date</label>
            </div>
        </div>
    </div>

    <!-- Information Section -->
    <div class="info-section">
        <h5>Using the Bill From Date</h5>
        <p class="mb-0">
            The Bill From Date represents premium period(s) you are getting paid for on each statement. 
            Depending on how often the carrier sends statements there could be more than one bill from date in the file. 
            <a href="#" class="text-primary">Learn more</a> about missing commissions reports.
        </p>
    </div>

    <!-- Section Divider -->
    <div class="section-divider"></div>

    <!-- Date Range Section -->
    <div class="form-section">
        <h5 class="section-title">Bill From Dates (up to 12 months)</h5>
        <div class="form-grid">
            <div class="form-group">
                <label for="startMonth">Start Month *</label>
                <select id="startMonth" class="form-control" required>
                    <option value="">- Select -</option>
                    <option>January</option>
                    <option>February</option>
                    <option>March</option>
                    <option>April</option>
                    <option>May</option>
                    <option>June</option>
                    <option>July</option>
                    <option>August</option>
                    <option>September</option>
                    <option>October</option>
                    <option>November</option>
                    <option>December</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="startYear">Start Year *</label>
                <select id="startYear" class="form-control" required>
                    <option value="">- Select -</option>
                    {% for year in years %}
                        <option>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="endMonthYear">End Month/Year *</label>
                <select id="endMonthYear" class="form-control" disabled required>
                    <option value="">- Select -</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Section Divider -->
    <div class="section-divider"></div>

    <!-- Filters Section -->
    <div class="form-section">
        <h5 class="section-title">Filters</h5>
        <div class="form-grid">
            <!-- Date Range -->
            <div class="form-group">
                <label>Effective Date Range</label>
                <div class="date-range-container">
                    <div class="date-input-group">
                        <input type="date" class="form-control form-control-sm date-input" placeholder="Start">
                        <span class="date-separator">to</span>
                        <input type="date" class="form-control form-control-sm date-input" placeholder="End">
                    </div>
                </div>
            </div>
            
            <!-- Who Is Covered 1 -->
            <div class="form-group">
                <label>Who Is Covered</label>
                <div class="checkbox-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="team1" name="team[]" value="north">
                        <label for="team1">Option 1</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="team2" name="team[]" value="south">
                        <label for="team2">Option 2</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="team3" name="team[]" value="east">
                        <label for="team3">Option 3</label>
                    </div>
                </div>
            </div>
            
            <!-- Who Is Covered 2 -->
            <div class="form-group">
                <label>Additional Filters</label>
                <div class="checkbox-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter1" name="filter[]" value="1">
                        <label for="filter1">Filter A</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter2" name="filter[]" value="2">
                        <label for="filter2">Filter B</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter3" name="filter[]" value="3">
                        <label for="filter3">Filter C</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Divider -->
    <div class="section-divider"></div>

    <!-- Report Options -->
    <div class="form-section">
        <h5 class="section-title">Report Options</h5>
        <div class="report-options">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="includeSSN">
                <label class="form-check-label" for="includeSSN">Include SSN / DOB / Medicare ID</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="includePrimaryAddress">
                <label class="form-check-label" for="includePrimaryAddress">Include Primary Address / Phone</label>
            </div>
        </div>
    </div>

    <!-- Section Divider -->
    <div class="section-divider"></div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="downloadReportBtn" class="btn btn-success">
            <i class="fas fa-download"></i> Download Report This Policy
        </button>
        <button class="btn btn-outline-secondary">
            <i class="fas fa-undo"></i> Reset
        </button>
    </div>
</div>

<script>
    // Enable end month/year dropdown when start month/year are selected
    document.getElementById('startMonth').addEventListener('change', updateEndMonthYear);
    document.getElementById('startYear').addEventListener('change', updateEndMonthYear);

    function updateEndMonthYear() {
        const startMonth = document.getElementById('startMonth').value;
        const startYear = document.getElementById('startYear').value;
        const endSelect = document.getElementById('endMonthYear');
        
        if (startMonth && startYear) {
            endSelect.disabled = false;
            endSelect.innerHTML = '<option value="">- Select -</option>';
            
            // Generate up to 12 months options
            const startDate = new Date(`${startMonth} 1, ${startYear}`);
            for (let i = 0; i < 12; i++) {
                const date = new Date(startDate);
                date.setMonth(date.getMonth() + i);
                const monthName = date.toLocaleString('default', { month: 'long' });
                const year = date.getFullYear();
                const option = document.createElement('option');
                option.value = `${monthName} ${year}`;
                option.textContent = `${monthName} ${year}`;
                endSelect.appendChild(option);
            }
        } else {
            endSelect.disabled = true;
        }
    }

    // Policy Report Download Functionality
    document.getElementById('downloadReportBtn').addEventListener('click', function() {
        // Collect all form data
        const formData = {
            policyId: "{{ policy.id }}",  // Assuming you have policy context
            policyNumber: "{{ policy.number }}",
            timeframe: document.querySelector('input[name="timeframe"]:checked').value,
            startDate: document.querySelector('.date-input-group input[placeholder="Start"]').value,
            endDate: document.querySelector('.date-input-group input[placeholder="End"]').value,
            includeSSN: document.getElementById('includeSSN').checked,
            includePrimaryAddress: document.getElementById('includePrimaryAddress').checked,
            generatedAt: new Date().toISOString()
        };
        
        // Get selected filters
        const selectedTeams = Array.from(document.querySelectorAll('input[name="team[]"]:checked'))
                                 .map(checkbox => checkbox.value);
        const selectedFilters = Array.from(document.querySelectorAll('input[name="filter[]"]:checked'))
                                  .map(checkbox => checkbox.value);
        
        // Create report content (CSV format)
        const reportContent = [
            ['Policy Commission Report', ''],
            ['Policy ID', formData.policyId],
            ['Policy Number', formData.policyNumber],
            ['Timeframe', formData.timeframe],
            ['Date Range', `${formData.startDate} to ${formData.endDate}`],
            ['Include SSN/DOB', formData.includeSSN ? 'Yes' : 'No'],
            ['Include Address/Phone', formData.includePrimaryAddress ? 'Yes' : 'No'],
            ['Selected Teams', selectedTeams.join('; ')],
            ['Selected Filters', selectedFilters.join('; ')],
            ['Report Generated', new Date(formData.generatedAt).toLocaleString()],
            [''],
            ['Commission Data', 'Amount', 'Date', 'Status'],
            // Sample data rows - replace with actual data from your backend
            ['Initial Commission', '$150.00', '2023-01-15', 'Paid'],
            ['Renewal Commission', '$75.00', '2023-02-15', 'Pending'],
            ['Bonus Commission', '$25.00', '2023-03-01', 'Paid']
        ].map(row => row.join(',')).join('\n');
        
        // Create download link
        const blob = new Blob([reportContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `policy_commission_report_${formData.policyNumber}.csv`);
        link.style.visibility = 'hidden';
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show download confirmation
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i> Download Started';
        setTimeout(() => {
            this.innerHTML = originalText;
        }, 2000);
    });
</script>
{% endblock %}