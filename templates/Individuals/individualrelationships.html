<style>
    .section-title1 {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        font-size: 2.3rem;
        color: #222222;
        letter-spacing: 0.05em;
        padding-bottom: 8px;
        text-transform: capitalize;
        margin: 5px 0 0 0;
    }

    /* Ensure dropdown menus are responsive */
    .dropdown-menu {
        max-width: 100vw;
        left: auto !important;
        right: 0 !important;
        font-size: 1.5rem;
    }

    .dropdown-menu li a {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    @media (max-width: 767px) {
        .agents-panel .panel-heading {
            display: block !important;
        }

        .agents-panel .panel-heading h4 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 0 10px 0;
            width: 100%;
            font-size: 1.8rem;
            /* Reduced for mobile */
        }

        .mobile-btn-container {
            display: flex;
            justify-content: flex-start;
            width: 100%;
            margin-top: 10px;
        }

        .agents-panel .panel-heading .btn-group.pull-right {
            display: none !important;
        }

        /* Mobile-specific dropdown adjustments */
        .dropdown-menu {
            position: fixed !important;
            width: 90% !important;
            max-width: 300px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            top: auto !important;
            bottom: 10px !important;
        }

        .dropdown-menu.dropdown-menu-right {
            left: auto !important;
            right: 10px !important;
            transform: none !important;
        }

        /* Ensure select dropdowns are responsive */
        select.form-control {
            max-width: 100%;
        }
    }

    @media (min-width: 768px) {
        .mobile-btn-container {
            display: none !important;
        }

        /* Desktop dropdown positioning */
        .dropdown-menu-right {
            right: 0;
            left: auto;
        }
    }

    /* General responsive adjustments */
    .edit-dropdown-wrapper {
        position: relative;
        display: inline-block;
        margin-left: -1px;
        max-width: 100%;
    }

    .edit-dropdown-wrapper select {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        padding-right: 25px;
        cursor: pointer;
        max-width: 100%;
    }

    .edit-dropdown-wrapper .caret {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    /* Modal responsiveness */
    @media (max-width: 767px) {
        .modal-dialog {
            margin: 10px;
            width: auto;
        }

        .modal-content {
            width: 100%;
        }
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .section-number {
        display: inline-block;
        background-color: #333;
        color: white;
        width: 24px;
        height: 24px;
        text-align: center;
        border-radius: 12px;
        margin-right: 10px;
        font-size: 14px;
        line-height: 24px;
    }

    .section-title {
        font-size: 16px;
        flex-grow: 1;
    }

    .section-container {
        margin-bottom: 20px;
    }

    .section-content {
        padding-left: 34px;
    }

    .well {
        background-color: #f5f5f5;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .address-box {
        border: 1px solid #ccc;
        padding: 10px 12px;
        border-radius: 3px;
        background-color: #fff;
        margin-bottom: 10px;
    }

    .address-box input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
        cursor: pointer;
    }

    /* Input group responsiveness */
    .input-group {
        flex-wrap: nowrap;
    }

    @media (max-width: 767px) {
        .input-group {
            flex-wrap: wrap;
        }

        .input-group input {
            width: 100% !important;
            border-radius: 4px !important;
            margin-bottom: 5px;
        }

        .input-group-append {
            width: 100%;
        }

        .input-group-append select {
            width: 100% !important;
            border-radius: 4px !important;
            border-left: 1px solid #ced4da !important;
        }
    }
     /* Add these styles to your existing CSS */
    #createNewRelationshipsContainer .form-group {
        margin-bottom: 15px;
    }
    
    #createNewRelationshipsContainer .input-group {
        display: flex;
        flex-wrap: nowrap;
    }
    
    #createNewRelationshipsContainer .input-group input {
        flex: 1;
        min-width: 0;
    }
    
    #createNewRelationshipsContainer .input-group-append {
        flex-shrink: 0;
    }
    
    @media (max-width: 767px) {
        #createNewRelationshipsContainer .form-row > .form-group {
            width: 100%;
            padding-right: 0;
            padding-left: 0;
        }
        
        #createNewRelationshipsContainer .input-group {
            flex-wrap: wrap;
        }
        
        #createNewRelationshipsContainer .input-group input {
            width: 100% !important;
            border-radius: 4px !important;
            margin-bottom: 5px;
        }
        
        #createNewRelationshipsContainer .input-group-append {
            width: 100%;
        }
        
        #createNewRelationshipsContainer .input-group-append select {
            width: 100% !important;
            border-radius: 4px !important;
            border-left: 1px solid #ced4da !important;
        }
        
        #createNewRelationshipsContainer .form-group.col-md-4 {
            width: 100%;
            padding-right: 0;
            padding-left: 0;
        }
    }
    
    @media (min-width: 768px) and (max-width: 991px) {
        #createNewRelationshipsContainer .form-group.col-md-4 {
            width: 50%;
        }
    }
</style>

<div class="tab-pane" id="Relationships-individuals">
    <!-- Main Content -->
    <div id="RelationshipsMainContent">
        <div class="agents-panel panel panel-default">
            <div class="panel-heading clearfix">
                <h4 class="section-title1 pull-left">Relationships for {{individual.first_name}} {{individual.last_name}}</h4>

                <!-- Desktop Buttons -->
                <div class="btn-group pull-right d-none d-sm-inline-block">
                    <button type="button" class="btn btn-primary" onclick="RelationshipsUI.showCreateNew()">
                        <i class="fa fa-plus"></i> Add
                    </button>
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        <i class="fa fa-angle-down"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a href="{% url 'manage_agencies' %}" target="_blank">Mass Update</a></li>
                    </ul>
                </div>

                <!-- Mobile Buttons -->
                <div class="mobile-btn-container d-block d-sm-none">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="RelationshipsUI.showCreateNew()">
                            <i class="fa fa-plus"></i> Add
                        </button>
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                            <i class="fa fa-angle-down"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'manage_agencies' %}" target="_blank">Mass Update</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="panel-body table-responsive">
                <table id="example10" class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Relationship</th>
                            <th>Name</th>
                            <th>Smoker Status</th>
                            <th>SSN</th>
                            <th>Date of Birth</th>
                            <th>Age</th>
                            <th>Gender</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rel in relationship_data %}
                        <tr>
                            <td>{{ rel.relationship }}</td>
                            <td>{{ rel.name }}</td>
                            <td>{{ rel.smoker_status }}</td>
                            <td>{{ rel.ssn }}</td>
                            <td>{{ rel.dob }}</td>
                            <td>{{ rel.age }}</td>
                            <td>{{ rel.gender }}</td>
                            
                        </tr>
                        
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create New Relationship Form -->
    <div id="createNewRelationshipsContainer" style="display: none;">
        <div class="panel panel-default">
            <div class="panel-heading d-flex justify-content-between align-items-center">
                <strong>Edit Relationship</strong>
            </div>
            <hr style="margin: 0;">
            <div class="panel-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group col-md-4">
                        <label>Name <span class="text-danger">*</span></label>
                        <div class="input-group" style="display: flex;">
                                <input type="text" class="form-control" id="relationshipNameInput" name="relation_name" placeholder="Type to search"
                                style="width: 190px; border-top-right-radius: 0; border-bottom-right-radius: 0;">

                            <input type="hidden" id="individualIdInput" name="individual_id"> 

                            <div class="input-group-append">
                                <select class="form-control form-control-sm" id="editRelationshipDropdown"
                                    style="background-color: #e9ecef;width: 90px; border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 0;">
                                    <option value="existing" selected>Use Existing</option>
                                    <option value="new">Create New Individual</option>
                                    <option value="basic">Basic Info</option>
                                </select>
                            </div>
                        </div>
                        <div id="existingSuggestions" class="dropdown-menu" style="display: none; max-height: 150px; overflow-y: auto;"></div>
                    </div>

                    <div class="form-group col-md-4">
                        <label>Relationship to Individual <span class="text-danger">*</span></label>
                        <select class="form-control" name="relationship">
                            <option disabled selected>Select relationship</option>
                            <optgroup label="Personal">
                                <option value="Common Law">Common Law</option>
                                <option value="Domestic Partner">Domestic Partner</option>
                                <option value="Ex-Spouse">Ex-Spouse</option>
                                <option value="Life Partner">Life Partner</option>
                                <option value="Significant Other">Significant Other</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Widow">Widow</option>
                                <option value="Widower">Widower</option>
                            </optgroup>
                            <optgroup label="Family">
                                <option value="Child">Child</option>
                                <option value="Foster Child">Foster Child</option>
                                <option value="Foster Parent">Foster Parent</option>
                                <option value="Grandchild">Grandchild</option>
                                <option value="Grandparent">Grandparent</option>
                                <option value="In-Law">In-Law</option>
                                <option value="Parent">Parent</option>
                                <option value="Relative">Relative</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Step Grandparent">Step Grandparent</option>
                                <option value="Stepchild">Stepchild</option>
                                <option value="Stepsibling">Stepsibling</option>
                            </optgroup>
                            <optgroup label="Legal">
                                <option value="Beneficiary">Beneficiary</option>
                                <option value="Conservatee">Conservatee</option>
                                <option value="Conservator">Conservator</option>
                                <option value="Dependent">Dependent</option>
                                <option value="Fiduciary">Fiduciary</option>
                                <option value="Fiduciary Principal">Fiduciary Principal</option>
                                <option value="Legal Guardian">Legal Guardian</option>
                                <option value="POA Principal">POA Principal</option>
                                <option value="Power of Attorney">Power of Attorney</option>
                                <option value="Trustee">Trustee</option>
                                <option value="Ward">Ward</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="Other">Other</option>
                            </optgroup>
                        </select>

                    </div>

                    <div class="form-group col-md-4">
                        <label>Notes</label>
                        <textarea class="form-control" rows="3" name="relation_notes"></textarea>
                    </div>
                    <hr>
                    <div class="form-group w-50">
                        <label for="correspondingToggle">Add Corresponding Relationship?</label>
                        <select id="correspondingToggle" class="form-control form-control-sm" name="corresponding">
                            <option value="">--Select--</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>

                    <hr>
                    <div id="correspondingSection" style="display: none;">
                        <h5>
                            <strong>Corresponding Relationship</strong>
                            <small><a href="#"><i>(What is this?)</i></a></small>
                        </h5>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Name</label>
                                <p><strong>{{individual.first_name}} {{individual.last_name}}</strong></p>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Corresponding Relationship <span class="text-danger">*</span></label>
                                <select class="form-control" name="corresponding_relationship">
                                    <option disabled selected>Select relationship</option>
                                    <optgroup label="Personal">
                                        <option value="Common Law">Common Law</option>
                                        <option value="Domestic Partner">Domestic Partner</option>
                                        <option value="Ex-Spouse">Ex-Spouse</option>
                                        <option value="Life Partner">Life Partner</option>
                                        <option value="Significant Other">Significant Other</option>
                                        <option value="Spouse">Spouse</option>
                                        <option value="Widow">Widow</option>
                                        <option value="Widower">Widower</option>
                                    </optgroup>
                                    <optgroup label="Family">
                                        <option value="Child">Child</option>
                                        <option value="Foster Child">Foster Child</option>
                                        <option value="Foster Parent">Foster Parent</option>
                                        <option value="Grandchild">Grandchild</option>
                                        <option value="Grandparent">Grandparent</option>
                                        <option value="In-Law">In-Law</option>
                                        <option value="Parent">Parent</option>
                                        <option value="Relative">Relative</option>
                                        <option value="Sibling">Sibling</option>
                                        <option value="Step Grandparent">Step Grandparent</option>
                                        <option value="Stepchild">Stepchild</option>
                                        <option value="Stepsibling">Stepsibling</option>
                                    </optgroup>
                                    <optgroup label="Legal">
                                        <option value="Beneficiary">Beneficiary</option>
                                        <option value="Conservatee">Conservatee</option>
                                        <option value="Conservator">Conservator</option>
                                        <option value="Dependent">Dependent</option>
                                        <option value="Fiduciary">Fiduciary</option>
                                        <option value="Fiduciary Principal">Fiduciary Principal</option>
                                        <option value="Legal Guardian">Legal Guardian</option>
                                        <option value="POA Principal">POA Principal</option>
                                        <option value="Power of Attorney">Power of Attorney</option>
                                        <option value="Trustee">Trustee</option>
                                        <option value="Ward">Ward</option>
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="Other">Other</option>
                                    </optgroup>
                                </select>

                            </div>

                            <div class="form-group col-md-4">
                                <label>Notes</label>
                                <textarea class="form-control" rows="3" name="corresponding_notes"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-success"><i class="fa fa-save"></i> Save</button>
                        <button type="button" class="btn btn-default"
                            onclick="RelationshipsUI.showNotesMain()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Individual Modal -->
<div class="modal fade" id="newIndividualModal" tabindex="-1" role="dialog" aria-labelledby="newIndividualModalLabel">
    <div class="modal-dialog modal-md-sm" role="document">
        <div class="modal-content">
  <div class="modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 0;">
    <h4 class="modal-title" id="newIndividualModalLabel" style="margin: 0; padding-top: 4px;"><strong>New Individual</strong></h4>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin: -10px -10px 0 0; padding: 0; line-height: 1;">
        <span aria-hidden="true" style="font-size: 1.9rem;">&times;</span>
    </button>
</div>

            <div class="modal-body">
                <form id="individualForm">

                    <!-- Section 1: Individual Info -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(1)">
                            <div class="section-number">1</div>
                            <div class="section-title text-success">
                                Individual Info <span class="text-danger">Please review the required fields.</span>
                            </div>
                        </div>
                        <div class="section-content" id="section-1">
                            <div class="row">
                                <div class="form-group col-md-4 col-12">
                                <label>First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="first_name" id="firstName">
                                </div>
                                <div class="form-group col-md-4 col-12">
                                <label>Middle Name</label>
                                <input type="text" class="form-control" name="middle_name" id="middleName">
                                </div>
                                <div class="form-group col-md-4 col-12">
                                <label>Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="last_name" id="lastName">
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group col-md-4 col-12">
                                <label>Type</label>
                                <select class="form-control" name="type" id="type">
                                    <option value="">-- Select Type --</option>
                                    <option value="Prospect">Prospect</option>
                                    <option value="Client">Client</option>
                                    <option value="Ex-Prospect">Ex-Prospect</option>
                                    <option value="Ex-Client">Ex-Client</option>
                                    <option value="Contact">Contact</option>
                                </select>
                                </div>
                                <div class="form-group position-relative col-md-4 col-12">
                                <label>Servicing Agent</label>
                                <input type="text" class="form-control" id="servicing_agents" autocomplete="off">
                                <input type="hidden" id="servicing_agent_ids" name="servicing_agent_ids">
                                <div id="agentSuggestionss" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="form-group col-md-4 col-12">
                                <label>Email</label>
                                <input type="email" class="form-control" name="email" id="email">
                                </div>
                            </div>

                            <!-- Business Phone -->
                            <div class="form-group row">
                                <label class="col-sm-2 col-12 col-form-label">Business Phone/Ext.</label>
                                <div class="col-sm-5 col-8">
                                <input type="text" name="business_phone" id="businessPhone" class="form-control" placeholder="Phone">
                                </div>
                                <div class="col-sm-2 col-4">
                                <input type="text" name="business_ext" id="businessex" class="form-control" placeholder="ext">
                                </div>
                            </div>

                            <!-- Home Phone -->
                            <div class="form-group row">
                                <label class="col-sm-2 col-12 col-form-label">Home Phone/Ext.</label>
                                <div class="col-sm-5 col-8">
                                <input type="text" name="home_phone" id="homePhone" class="form-control" placeholder="Phone">
                                </div>
                                <div class="col-sm-2 col-4">
                                <input type="text" name="home_ext" id="homeex" class="form-control" placeholder="ext">
                                </div>
                            </div>

                            <!-- Cell Phone -->
                            <div class="form-group row">
                                <label class="col-sm-2 col-12 col-form-label">Cell Phone/Ext.</label>
                                <div class="col-sm-5 col-8">
                                <input type="text" name="cell_phone" id="cellPhone" class="form-control" placeholder="Phone">
                                </div>
                                <div class="col-sm-2 col-4">
                                <input type="text" name="cell_ext" id="cellex" class="form-control" placeholder="ext">
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Section 2: Associate Individual -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(2)">
                            <div class="section-number">2</div>
                            <div class="section-title text-success">Associate Individual</div>
                        </div>
                        <div class="section-content" id="section-2" style="display: none;">
                            <div class="form-group">
                                <label for="record_type">Select Record Type</label>
                                <select class="form-control" id="record_type" name="record_type"
                                    onchange="toggleCarrierField(this.value)">
                                    <option value="">-- Select Record Type --</option>
                                    <option value="existing">Existing Carrier</option>
                                    <option value="new">New Carrier</option>  
                                </select>
                                <div class="well" style="background-color: #f5f5f5; padding: 15px; margin-top: 10px;">
                                    <p style="margin-bottom: 0;">Track and manage carrier contacts. <a href="#">Learn
                                            more</a>.</p>
                                </div>
                            </div>

                            <div class="form-group" id="carrier_name_group" style="display:none; position: relative;">
                                <label for="carrier_name">Carrier Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="carrier_name" id="carrier_name" placeholder="Type to search" autocomplete="off">
                                <div id="carrier_suggestions" class="list-group" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;"></div>
                            </div>
                        </div>
                    </div>


                    <hr>

                    <!-- Section 3: Address Info -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(3)">
                            <div class="section-number">3</div>
                            <div class="section-title text-success">Address Info <small>(optional)</small></div>
                        </div>
                        <div class="section-content" id="section-3" style="display: none;">
                            <label class="mb-2">Addresses</label>
                            <div class="address-box">
                                {% for add in individual_address %}
                                    <label class="d-flex align-items-center m-0" style="width: 100%;">
                                        <input type="checkbox" class="me-2" name="address_ids" value="{{ add.id }}">
                                        <span>{{ add.address_type }} - {{ add.address1 }} {{ add.address2 }} {{ add.city }} {{ add.state }} {{ add.zip_code }}</span>
                                    </label>
                                {% endfor %}
                        </div>
                        </div>
                    </div>

                    <p class="text-muted">Fields marked with an <span class="text-danger">*</span> are required.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveNewIndividual"><i class="fa fa-save"></i> Save</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Basic Info Modal -->
<div class="modal fade" id="basicinfoModal" tabindex="-1" role="dialog" aria-labelledby="basicinfoModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span>&times;</span></button>
                <h4 class="modal-title" id="basicinfoModalLabel">Basic Information</h4>
            </div>
            
            <div class="modal-body">

                <p class="text-danger"><strong>Please review the required fields.</strong></p>
                
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label>First Name <span class="text-danger">*</span></label>
                            <input type="text" id="basicFirstName" name="first_name" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Middle Name</label>
                            <input type="text" id="basicMiddleName" name="middle_name" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Last Name <span class="text-danger">*</span></label>
                            <input type="text" id="basicLastName" name="last_name" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Date of Birth <span class="text-danger"></span></label>
                            <input type="date" id="basicDOB" name="dob" class="form-control" placeholder="">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label>Gender</label>
                            <select id="basicGender" name="gender" class="form-control">
                                <option value="">-- Select Type --</option>
                                <option value="F">F</option>
                                <option value="M">M</option>
                            </select>

                        </div>
                        <div class="form-group col-md-4">
                            <label>SSN</label>
                            <input type="text" id="basicSSN" name="ssn" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Smoker Status</label>
                            <select id="basicSmoker" name="smoker_status" class="form-control">
                                <option value="">-- Select Type --</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>

                    </div>
                
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success" id="saveBasicInfo"><i class="fa fa-save"></i> Save</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
           
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script>
$(document).ready(function () {
  $("#servicing_agents").on("input", function () {
    let query = $(this).val();
    if (query.length >= 2) {
      $.ajax({
        url: "/agents/search/",
        data: { term: query },
        success: function (data) {
          let suggestions = "";
          if (data.length === 0) {
            suggestions = '<a href="#" class="list-group-item list-group-item-action disabled">No results found</a>';
          } else {
            data.forEach(agent => {
              suggestions += `<a href="#" class="list-group-item list-group-item-action" data-id="${agent.id}" data-label="${agent.label}">${agent.label}</a>`;
            });
          }
          $("#agentSuggestionss").html(suggestions).show();
        }
      });
    } else {
      $("#agentSuggestionss").empty().hide();
    }
  });

  $(document).on("click", "#agentSuggestionss a", function (e) {
    e.preventDefault();
    const name = $(this).data("label");
    const id = $(this).data("id");
    $("#servicing_agents").val(name);
    $("#servicing_agent_ids").val(id);
    $("#agentSuggestionss").empty().hide();
  });

  $("#servicing_agents").on("blur", function () {
    setTimeout(() => {
      $("#agentSuggestionss").fadeOut();
    }, 150);
  });
});
</script>

<script>
    var RelationshipsUI = {
        init: function () {
            
            $('#relationshipNameInput').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: '/individuals/search/relationship/',  
                        dataType: 'json',
                        data: { term: request.term },
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    $('#relationshipNameInput').val(ui.item.label);
                    $('#relationshipNameInput').data('individual-id', ui.item.id); 
                }
            });

            // Form submission
            $('#activityForm').on('submit', function (e) {
                e.preventDefault();
                RelationshipsUI.showNotesMain();
                location.reload();
            });

            // Toggle corresponding
            $('#correspondingToggle').change(function () {
                $('#correspondingSection').toggle($(this).val() === 'yes');
            });

            // Dropdown change handler
            $('#editRelationshipDropdown').change(function () {
                var action = $(this).val();
                $(this).val('');
                if (action === 'existing') {
                    $('#relationshipNameInput').focus();
                } else if (action === 'new') {
                    $('#newIndividualModal').modal('show');
                } else if (action === 'basic') {
                    $('#basicinfoModal').modal('show');
                }
            });

            // Save New Individual
            $('#saveNewIndividual').on('click', function () {
                var address_ids = [];
                $('input[name="address_ids"]:checked').each(function () {
                    address_ids.push($(this).val());
                });
                var data = {
                    first_name: $('#firstName').val(),
                    middle_name: $('#middleName').val(),
                    last_name: $('#lastName').val(),
                    individual_type: $('#type').val(),  
                    email: $('#email').val(),
                    servicing_agent_ids: $('#servicing_agent_ids').val(),
                    business_phone: $('#businessPhone').val(),
                    home_phone: $('#homePhone').val(),
                    cell_phone: $('#cellPhone').val(),
                    business_ext: $('#businessex').val(),
                    home_ext: $('#homeex').val(),
                    cell_ext: $('#cellex').val(),
                    carrier_name: $('#carrier_name').val(),
                    record_type: $('#record_type').val(),
                    address_ids: address_ids, 

                    csrfmiddlewaretoken: '{{ csrf_token }}'
                };


                $.post('/individuals/create/relationship/', data, function (response) {
                    if (response.success) {
                        const fullName = response.first_name + ' ' + response.last_name;
                        $('#relationshipNameInput').val(fullName);
                        $('#relationshipNameInput').data('individual-id', response.id);
                        $('#newIndividualModal').modal('hide');
                    } else {
                        alert('Failed to save individual.');
                    }
                });
            });

            // Save Basic Info (no DB save)
            $('#saveBasicInfo').on('click', function () {
                const data = {
                    first_name: $('#basicFirstName').val(),
                    middle_name: $('#basicMiddleName').val(),
                    last_name: $('#basicLastName').val(),
                    dob: $('#basicDOB').val(),
                    gender: $('#basicGender').val(),
                    ssn: $('#basicSSN').val(),
                    smoker_status: $('#basicSmoker').val(),
                    individual_id: $('#relationshipNameInput').data('individual-id') || '',  // Handle undefined
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                };

                $.post('/individuals/save/basicinfo/', data, function (response) {
                    if (response.success) {
                        const fullName = data.first_name + ' ' + (data.middle_name ? data.middle_name + ' ' : '') + data.last_name;
                        $('#relationshipNameInput').val(fullName);
                        $('#basicinfoModal').modal('hide');
                    } else {
                        console.error("Error:", response.error);  
                        alert('Failed to save basic info: ' + response.error);  
                    }
                });
            });


        },

        showCreateNew: function () {
            $('#RelationshipsMainContent').hide();
            $('#createNewRelationshipsContainer').show();
            $('html, body').animate({
                scrollTop: $('#createNewRelationshipsContainer').offset().top - 20
            }, 'smooth');
        },

        showNotesMain: function () {
            $('#RelationshipsMainContent').show();
            $('#createNewRelationshipsContainer').hide();
            $('#activityForm')[0].reset();
            $('#correspondingSection').hide();
        },
    };

    // Init and Section toggle
    $(document).ready(function () {
        RelationshipsUI.init();

        $('#section-1').show();
        $('#section-2').hide();
        $('#section-3').hide();

        $('#newIndividualModal').on('show.bs.modal', function (e) {
            const trigger = $(e.relatedTarget);
            $('.section-content').hide();

            if (trigger.hasClass('address-info-trigger')) $('#section-3').show();
            else if (trigger.hasClass('associate-individual-trigger')) $('#section-2').show();
            else $('#section-1').show();
        });

        $('#carrierNameContainer').hide();
    });

    function toggleSection(sectionNum) {
        $('.section-content').not('#section-' + sectionNum).slideUp();
        $('#section-' + sectionNum).slideToggle();
    }

    function toggleCarrierField(recordType) {
        const container = $('#carrierNameContainer');
        const input = $('#carrierName');
        if (recordType === 'carrier') {
            container.show();
            input.attr('placeholder', 'Enter new carrier name');
        } else if (recordType === 'vendor') {
            container.show();
            input.attr('placeholder', 'Type to search existing carriers');
        } else {
            container.hide();
            input.val('');
        }
    }
</script>

<script>
document.getElementById('record_type').addEventListener('change', function () {
  const carrierGroup = document.getElementById('carrier_name_group');
  carrierGroup.style.display = this.value ? 'block' : 'none';
});

document.getElementById('carrier_name').addEventListener('input', function () {
  const input = this.value;
  const dropdown = document.getElementById('carrier_suggestions');

  if (input.length > 1) {
    fetch(`/search-carriers/?q=${encodeURIComponent(input)}`)
      .then(response => response.json())
      .then(data => {
        dropdown.innerHTML = '';
        if (data.length > 0) {
          data.forEach(carrier => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.textContent = carrier.name;
            item.href = '#';
            item.onclick = function (e) {
              e.preventDefault();
              document.getElementById('carrier_name').value = carrier.name;
              dropdown.style.display = 'none';
            };
            dropdown.appendChild(item);
          });
          dropdown.style.display = 'block';
        } else {
          dropdown.style.display = 'none';
        }
      });
  } else {
    dropdown.style.display = 'none';
  }
});

document.addEventListener('click', function (e) {
  const dropdown = document.getElementById('carrier_suggestions');
  if (!document.getElementById('carrier_name_group').contains(e.target)) {
    dropdown.style.display = 'none';
  }
});
</script>
