{% extends "dashboard/base.html" %}
{% load static %}
{% load phone_filters %}
{% block main-content %}
<style>
    /* Your existing styles remain unchanged */
    /* Dropdown menu styles */
    .nav-tabs .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        display: none;
        float: left;
        min-width: 160px;
        padding: 5px 0;
        margin: 2px 0 0;
        font-size: 14px;
        text-align: left;
        list-style: none;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
    }

    .nav-tabs .dropdown-menu>li>a {
        display: block;
        padding: 3px 20px;
        clear: both;
        font-weight: 400;
        line-height: 1.42857143;
        color: #333;
        white-space: nowrap;
    }

    .nav-tabs .dropdown-menu>li>a:hover,
    .nav-tabs .dropdown-menu>li>a:focus {
        color: #262626;
        text-decoration: none;
        background-color: #f5f5f5;
    }

    .nav-tabs .open>a,
    .nav-tabs .open>a:hover,
    .nav-tabs .open>a:focus {
        background-color: #fff;
        border-color: #ddd;
    }

    /* Ensure dropdowns appear above other content */
    .nav-tabs .dropdown {
        position: relative;
    }

    /* Fix for mobile view */
    @media (max-width: 767px) {
        .nav-tabs .dropdown-menu {
            position: static;
            float: none;
            width: auto;
            margin-top: 0;
            background-color: transparent;
            border: 0;
            box-shadow: none;
        }

        .nav-tabs .dropdown-menu>li>a {
            padding: 5px 15px 5px 25px;
        }

        .nav-tabs .dropdown-toggle .caret {
            display: none;
        }
    }

    /* Content area styling */
    .tab-content-container {
        background: white;
        padding: 20px 15px;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }

    /* Section styling */
    .custom-section {
        padding: 20px 0;
        border-top: 1px solid #e9ecef;
    }

    .custom-section:first-of-type {
        border-top: none;
        padding-top: 0;
    }

    .agent-info-container {
        background-color: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
        border: 1px solid #e1e4e8;
    }

    .agent-info-section {
        margin-bottom: 15px;
    }

    .form-group-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -6px 15px -6px;
    }

    .form-group-col {
        padding: 0 6px;
        flex: 1 0 160px;
        min-width: 160px;
    }

    .form-group-col label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #586069;
        font-size: 12px;
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #e1e4e8;
        border-radius: 3px;
        font-size: 12px;
        height: 32px;
    }

    .date-range-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .date-range-group {
        flex: 1;
        min-width: 200px;
    }

    .date-range-row {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .date-range-row .form-control {
        flex: 1;
    }

    .search-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-top: 1px solid #e1e4e8;
    }

    .btn {
        padding: 8px 12px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid transparent;
    }

    .btn-primary {
        background-color: #07408b;
        border-color: #07408b;
        color: white;
    }

    .btn-secondary {
        background-color: #f6f8fa;
        color: #24292e;
        border-color: #d1d5da;
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 15px 0;
        color: #24292e;
        padding-bottom: 6px;
        border-bottom: 1px solid #e1e4e8;
    }

    .checkbox-container {
        border: 1px solid #ced4da;
        border-radius: .25rem;
        max-height: 120px;
        overflow-y: auto;
        padding: 5px;
        width: 100%;
    }

    .checkbox-item {
        padding: 3px 0;
        margin: 0;
    }

    .checkbox-item input[type="checkbox"] {
        margin: 0 5px 0 0;
        vertical-align: middle;
    }

    .checkbox-item label {
        margin: 0;
        display: inline;
        font-size: 12px;
    }

    .compact-section {
        margin-bottom: 15px;
    }

    .attribute-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .attribute-col {
        flex: 1;
        min-width: 180px;
    }

    .tight-form-group {
        display: flex;
        gap: 10px;
    }

    .tight-form-group .form-group-col {
        flex: 1;
        min-width: 0;
    }

    .inline-sections {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-start;
    }

    .lead-date-section {
        flex: 1;
        min-width: 250px;
    }

    .primary-market-section {
        flex: 1;
        min-width: 220px;
    }

    .date-birth-section {
        margin: 15px 0;
        padding: 0 6px;
    }

    .date-birth-section label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    /* New styles for improved sections */
    .multi-checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
    }

    .multi-checkbox-section {
        flex: 1;
        min-width: 200px;
    }

    .multi-checkbox-section h4 {
        font-size: 13px;
        margin-bottom: 8px;
        color: #495057;
    }

    .business-name-section {
        margin-top: 15px;
    }

    /* Table styling for consistent spacing */
    .table-bordered {
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-bordered th,
    .table-bordered td {
        padding: 8px;
        vertical-align: middle;
    }

    /* Modal form spacing */
    .modal-body .form-group {
        margin-bottom: 15px;
    }

    /* Panel styling */
    .panel-default {
        border: 1px solid #e1e4e8;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .panel-heading {
        padding: 10px 15px;
        background-color: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
    }

    .panel-title {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
    }

    /* Button spacing */
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
    }

    /* Custom fields panel - centered text */
    .custom-fields-panel {
        padding: 15px;
        text-align: center;
        /* Center align all text */
    }

    .custom-fields-panel .alert {
        text-align: left;
        /* Keep alert text left-aligned */
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .alert {
        padding: 10px 15px;
        margin-bottom: 15px;
    }

    /* Fix for footer positioning */
    .container-default {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .content-wrapper {
        flex: 1;
    }

    .panel-heading {
        position: relative;
    }

    /* Adjust the last step to not show connector */
    .panel-default:last-child .step-connector {
        display: none;
    }

    /* Main container styling */
    .agent-profile-container {
        background: white;
        margin: 0;
        padding: 0;
    }

    /* Tab styling with increased distance */
    .nav-tabs {
        background: #f8f9fa;
        padding-left: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        -ms-overflow-style: -ms-autohiding-scrollbar;
    }

    .nav-tabs>li {
        margin-right: 15px;
        float: none;
        white-space: nowrap;
    }

    .nav-tabs>li>a {
        border: 1px solid transparent;
        border-radius: 4px 4px 0 0;
        background-color: #e9ecef;
        color: #495057;
        padding: 10px 15px;
    }

    .nav-tabs>li.active>a,
    .nav-tabs>li.active>a:hover,
    .nav-tabs>li.active>a:focus {
        background-color: white;
        color: #495057;
        border: 1px solid #dee2e6;
        border-bottom-color: transparent;
    }

    /* Page header styling */
    .page-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .page-title {
        margin: 0;
        font-size: 2rem;
        color: #333;
        flex: 1;
        min-width: 200px;
    }

    .search-agents-container {
        background-color: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e1e4e8;
        margin-bottom: 20px;
    }

    /* Responsive adjustments */
    @media (max-width: 767px) {
        .page-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .nav-tabs {
            padding-left: 10px;
            padding-right: 10px;
        }

        .nav-tabs>li {
            margin-right: 8px;
        }

        .nav-tabs>li>a {
            padding: 8px 12px;
            font-size: 12px;
        }

        .tab-content-container {
            padding: 10px;
        }

        .form-group-col {
            flex: 1 0 100%;
            margin-bottom: 10px;
        }

        .form-group-row {
            margin-bottom: 0;
        }

        .agent-info-container {
            padding: 10px;
        }

        .section-title {
            font-size: 14px;
        }

        .multi-checkbox-section {
            flex: 1 0 100%;
        }

        .search-actions {
            flex-direction: column;
            gap: 10px;
        }

        .search-actions .btn {
            width: 100%;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .position-relative .edit-tools {
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: 5px;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }

    @media (min-width: 768px) and (max-width: 991px) {
        .form-group-col {
            flex: 1 0 45%;
        }

        .multi-checkbox-section {
            flex: 1 0 45%;
        }
    }

    .required {
        color: red;
    }

    .custom-updated-info {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .custom-updated-info {
        font-size: 0.9rem;
        color: #6c757d;
    }


    #agent-summary {
        width: 300px;
        background: #fff;
        padding: 15px;
        border-left: 1px solid #ddd;
        position: fixed;
        right: -300px;
        top: 50px;
        height: calc(100vh - 50px);
        overflow-y: auto;
        z-index: 1000;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
    }

    #agent-summary.shown {
        right: 0;
    }

    .main-content-wrapper {
        transition: all 0.3s ease;
        padding-right: 0;
    }

    .main-content-wrapper.sidebar-shown {
        padding-right: 300px;
    }

    .summary-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .summary-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f5f5f5;
    }

    .summary-action-buttons {
        position: fixed;
        right: 30px;
        top: 80px;
        z-index: 1010;
    }

    .close-sidebar {
        position: absolute;
        right: 15px;
        top: 15px;
        cursor: pointer;
        color: #999;
    }

    .close-sidebar:hover {
        color: #333;
    }

    .summary-group {
        position: relative;
    }

    .summary-group .hover-label {
        position: absolute;
        top: 100%;
        left: 0;
        white-space: nowrap;
        background: #fff;
        padding: 2px 8px;
        border: 1px solid #ccc;
        font-size: 12px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 10;
        margin-top: 2px;
    }

    .summary-group button:hover+.hover-label {
        display: block;
    }

    /* Responsive adjustments for sidebar */
    @media (max-width: 1199px) {
        #agent-summary {
            width: 280px;
            right: -280px;
        }

        .main-content-wrapper.sidebar-shown {
            padding-right: 280px;
        }
    }

    @media (max-width: 991px) {
        .summary-action-buttons {
            right: 15px;
            top: 55px;
        }
    }

    @media (max-width: 768px) {
        #agent-summary {
            width: 250px;
            right: -250px;
        }

        .main-content-wrapper.sidebar-shown {
            padding-right: 250px;
        }

        .summary-action-buttons {
            top: 50px;
        }
    }

    @media (max-width: 576px) {
        #agent-summary {
            width: 100%;
            right: -100%;
        }

        .main-content-wrapper.sidebar-shown {
            padding-right: 0;
            transform: translateX(-100%);
        }

        .summary-action-buttons {
            position: relative;
            right: auto;
            top: auto;
            margin-bottom: 15px;
            text-align: right;
        }
    }

    .summary-item .rounded-circle {
        border: 2px solid #dee2e6;
    }

    .summary-item h4 {
        font-size: 16px;
        margin-bottom: 5px;
    }

    .summary-item .btn-sm {
        padding: 0.15rem 0.5rem;
        font-size: 12px;
    }

    .summary-item .d-flex {
        display: flex;
    }

    .summary-item .me-3 {
        margin-right: 1rem;
    }

    .summary-item .flex-grow-1 {
        flex-grow: 1;
    }

    .summary-item .mb-0 {
        margin-bottom: 0;
    }

    .summary-item .mb-2 {
        margin-bottom: 0.5rem;
    }

    .summary-item .align-items-center {
        align-items: center;
    }

    .summary-item .justify-content-between {
        justify-content: space-between;
    }

    /* User Profile Header Styles */
    .user-profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .user-photo-container {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 12px;
        border: 2px solid #dee2e6;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .user-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .default-user-icon {
        color: #6c757d;
        font-size: 20px;
    }

    .user-info {
        flex: 1;
    }

    .name-edit-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
    }

    .user-name {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .edit-btn {
        padding: 0.15rem 0.5rem;
        font-size: 12px;
        margin-left: 8px;
    }

    .user-type {
        color: #6c757d;
        font-size: 12px;
    }

    .label-group {
        margin-top: 5px;
    }

    .label-item {
        display: flex;
        justify-content: space-between;
        margin: 2px 0;
    }

    .badge {
        background-color: #444;
        color: #fff;
        border-radius: 5px;
        padding: 2px 6px;
        font-size: 0.8rem;
    }

    .toggle-link {
        display: block;
        margin-top: 5px;
        font-weight: 500;
        cursor: pointer;
    }
</style>

<!-- Summary Action Buttons -->
<div class="summary-action-buttons">
    <div class="btn-group summary-group position-relative">
        <button id="toggle-agent-summary" class="btn btn-default btn-sm">
            <i class="fa fa-list-alt"></i>
        </button>
        <div class="hover-label">Summary</div>

        <button class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <div class="hover-label">Action</div>

        <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="#"><i class="fa fa-print"></i> Print Record</a></li>
            <li class="divider"></li>
            <li><a href="#"><i class="fa fa-cog"></i> Print Page</a></li>
        </ul>
    </div>
</div>

<div class="main-content-wrapper">
    <div class="container-default">
        <div class="content-wrapper">
            <div class="search-agents-container">
                <!-- Page Header -->
                <div class="page-header-row">
                    <h1 class="page-title">{{agent.first_name}} {{agent.last_name}}</h1>
                </div>

                <!-- Tab Navigation -->
                <div class="nav-tabs-container">
                    <!-- Regular tabs as buttons -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#detail-content" class="btn btn-secondary nav-tab-btn active"
                            data-toggle="tab">Detail</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#agencies-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Agencies</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#clients-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Clients</a>
                    </div>

                    <!-- Other single tabs -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#policies-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Policies</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#activities-content" class="btn btn-secondary nav-tab-btn"
                            data-toggle="tab">Activities</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#notes-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Notes</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#eo-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">E&O</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#contracts-content" class="btn btn-secondary nav-tab-btn"
                            data-toggle="tab">Contracts</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#licenses-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Licenses</a>
                    </div>

                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <a href="#personal-content" class="btn btn-secondary nav-tab-btn" data-toggle="tab">Personal</a>
                    </div>
                    <!-- WorkFlow Dropdown -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <button type="button" class="btn btn-secondary nav-tab-btn dropdown-toggle"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            WorkFlow ▼
                        </button>
                        <ul class="dropdown-menu shadow p-2 border-0">
                            <li><a class="dropdown-item py-2" href="#agency-action" data-toggle="tab">Triggered
                                    Action</a></li>
                            <li><a class="dropdown-item py-2" href="#agency-detail" data-toggle="tab">Triggered
                                    Workflow</a></li>
                        </ul>
                    </div>

                    <!-- Email Dropdown -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <button type="button" class="btn btn-secondary nav-tab-btn dropdown-toggle"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Email ▼
                        </button>
                        <ul class="dropdown-menu shadow p-2 border-0">
                            <li><a class="dropdown-item py-2" href="#incoming-agency" data-toggle="tab">Incoming
                                    Emails</a></li>
                            <li><a class="dropdown-item py-2" href="#outgoing-agency" data-toggle="tab">Outgoing
                                    Emails</a></li>
                            <li><a class="dropdown-item py-2" href="#Campaigns-agency" data-toggle="tab">Campaigns</a>
                            </li>
                        </ul>
                    </div>

                    <!-- Messages Dropdown -->
                    <div class="btn-group nav-tab-btn-group me-3 mb-2">
                        <button type="button" class="btn btn-secondary nav-tab-btn dropdown-toggle"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Messages ▼
                        </button>
                        <ul class="dropdown-menu shadow p-2 border-0">
                            <li><a class="dropdown-item py-2" href="#Recordings-agency" data-toggle="tab">Call
                                    Recordings</a></li>
                            <li><a class="dropdown-item py-2" href="#SMS-agency" data-toggle="tab">SMS Messages
                                    History</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Tab Content Sections -->
                <div class="tab-content">
                    <!-- Detail Tab -->
                    {% include "agent/agent_detail.html" %}
                    {% include "agent/agencyagencies.html" %}
                    {% include "agent/agencyclient.html" %}
                    {% include "agent/agencypolicy.html" %}
                    {% include "agent/agencyactivity.html" %}
                    {% include "agent/agencynote.html" %}
                    {% include "agent/agencyeo.html" %}
                    {% include "agent/agencycontracts.html" %}
                    {% include "agent/agencylicenses.html" %}
                    {% include "agent/agencypersonal.html" %}

                    {% include "agent/agencyworkflowaction.html" %}

                    {% include "agent/agencyworkflowdetail.html" %}

                    {% include "agent/agencyinemails.html" %}

                    {% include "agent/agencyoutemails.html" %}

                    {% include "agent/agencycampaigns.html" %}

                    {% include "agent/agencyRecordings.html" %}

                    {% include "agent/agencySMS.html" %}
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Agent Summary Sidebar -->
<div id="agent-summary">
    <span class="close-sidebar" id="close-sidebar">&times;</span>

    <div class="summary-header">
        <h3><i class="fa fa-user"></i> Agent Summary</h3>
    </div>

    <div class="summary-item">
        <div class="user-profile-header">
            <!-- User Circle Photo -->
            {% comment %} <div class="user-photo-container">
                {% if agent.photo %}
                <img src="{{ agent.photo.url }}" alt="{{ agent.first_name }} {{ agent.last_name }}" class="user-photo">
                {% else %}
                <div class="default-user-icon">
                    <i class="fa fa-user"></i>
                </div>
                {% endif %}
            </div>


            <div class="user-info">

                <div class="name-edit-wrapper">
                    <h4 class="user-name">{{agent.first_name}} {{agent.last_name}}</h4>
                    <a href="{% url 'edit_agent' %}" class="btn btn-sm btn-outline-secondary edit-btn">

                        <i class="fa fa-edit"></i> Edit
                    </a>
                </div>
                <small class="user-type">Linked User</small>
            </div> {% endcomment %}
            No linked User .
        </div>
    </div>


    <div class="summary-item">
    <h4><i class="fa fa-user"></i> Contact Info</h4>

    <p class="text" style="color: black;">
        Email:
        <span style="color: blue;">
            <a href="mailto:{{agent.email}}" style="color: blue;">{{agent.email}}</a>
        </span>
    </p>

    {% for phone in agent_phones %}
    <p class="text" style="color: black;">
        {{phone.phone_type}}:
        <span style="color: blue;">{{phone.number|format_phone}}</span>
    </p>
    {% endfor %}
</div>

    <div class="agent-summary-section border-top pt-2 mt-2">


        <div class="summary-item">
            <h4><i class="fa fa-users"></i> Clients</h4>
            <div class="label-group">
                <span>Individuals</span>

                {% for item in individual_type_counts %}
                    {% if forloop.counter <= 3 %}
                        <div class="label-item">
                            {{ item.individual_type|default:"Unknown" }}
                            <span class="badge">{{ item.count }}</span>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if individual_type_counts|length > 3 %}
                    <a href="javascript:void(0);" class="toggle-link text-primary show-more-link">Show More...</a>
                {% endif %}
            </div>

            {% if individual_type_counts|length > 3 %}
                <div class="additional-content" style="display: none;">
                    {% for item in individual_type_counts %}
                        {% if forloop.counter > 3 %}
                            <div class="label-item">
                                {{ item.individual_type|default:"Unknown" }}
                                <span class="badge">{{ item.count }}</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <a href="javascript:void(0);" class="toggle-link text-primary show-less-link">Show Less...</a>
                </div>
            {% endif %}
        </div>


        <hr class="my-3">


        <div class="summary-item">
    <h4><i class="fa fa-file-medical"></i> In Force Policies</h4>
    <div class="label-group">
        <span>Individuals</span>

        {% for item in policy_coverage_counts %}
            {% if forloop.counter <= 4 %}
                <div class="label-item">
                    {{ item.coverage_type|default:"Unknown" }}
                    <span class="badge">{{ item.count }}</span>
                </div>
            {% endif %}
        {% endfor %}

        {% if policy_coverage_counts|length > 4 %}
            <a href="javascript:void(0);" class="toggle-link text-primary show-more-link">Show More...</a>
        {% endif %}
    </div>

    {% if policy_coverage_counts|length > 4 %}
        <div class="additional-content" style="display: none;">
            {% for item in policy_coverage_counts %}
                {% if forloop.counter > 4 %}
                    <div class="label-item">
                        {{ item.coverage_type|default:"Unknown" }}
                        <span class="badge">{{ item.count }}</span>
                    </div>
                {% endif %}
            {% endfor %}
            <a href="javascript:void(0);" class="toggle-link text-primary show-less-link">Show Less...</a>
        </div>
    {% endif %}
</div>


    </div>


<div class="summary-item">
    <h4><i class="fa fa-tasks"></i> Activities Due</h4>
    {% if due_activities %}
      {% for act in due_activities %}
     <p class="text-muted">
    <a href="#" class="activity-edit-link" 
       data-id="{{ act.id }}"
       data-subject="{{ act.subject }}"
       data-notes="{{ act.notes }}"
       data-status="{{ act.status }}"
       data-follow-up-user="{{ act.follow_up_user }}"
       data-follow-up-team="{{ act.follow_up_team }}"
       data-due-date="{{ act.due_date|date:'Y-m-d' }}"
       data-activity-date="{{ act.activity_date|date:'Y-m-d' }}"
       data-priority="{{ act.priority }}"
       data-type="{{ act.activity_type }}"
       data-method="{{ act.method }}"
       {% if act.attachment %}
       data-attachment="{{ act.attachment.url }}"
       {% endif %}>
        {{ act.subject }}
    </a>
</p>
      {% endfor %}
    {% else %}
      <p class="text-muted">No Activities.</p>
    {% endif %}
    <a href="#" class="btn btn-xs btn-success" id="createActivityBtn">
        <i class="fa fa-plus"></i> Create new
    </a>
</div>
<div class="summary-item">
    <h4><i class="fa fa-thumb-tack"></i> Pinned Note</h4>
    {% if pin_notess %}
      {% for note in pin_notess %}
      <p class="text-muted">
    <a href="#" class="pinned-note-link" 
       data-id="{{ note.id }}" 
       data-subject="{{ note.subject }}"
       data-notes="{{ note.notes }}"
       data-pinned="{{ note.pinned|lower }}"
       data-attachment="{% if note.attachment %}{{ note.attachment.url }}{% endif %}">
        {{ note.subject }}
    </a>
</p>
      {% endfor %}
      {% else %}
      <p class="text-muted">No pinned note.</p>
    {% endif %}
    <a href="#notes-content" class="btn btn-xs btn-info" id="create-pinnednote-from-sidebar" data-show-form="true">
        <i class="fa fa-plus"></i> Create new
    </a>
</div>

</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/bootstrap/bootstrap.min.js' %}"></script>

<script>
    $(document).ready(function () {
        // Initialize tabs
        $('#mainTabs a[data-toggle="tab"]').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        // Handle hash in URL
        if (location.hash) {
            $('a[href="' + location.hash + '"]').tab('show');
        }

        // Update hash when tab changes
        $('#mainTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            window.location.hash = e.target.hash;
        });

        // Initialize dropdowns
        $('.dropdown-toggle').dropdown();

        // Sidebar toggle functionality
        $('#toggle-agent-summary').click(function (e) {
            e.preventDefault();
            $('#agent-summary').toggleClass('shown');
            $('.main-content-wrapper').toggleClass('sidebar-shown');

            if ($(window).width() <= 576) {
                $('body').css('overflow-x', $('#agent-summary').hasClass('shown') ? 'hidden' : 'auto');
            }
        });

        $('#close-sidebar').click(function (e) {
            e.preventDefault();
            $('#agent-summary').removeClass('shown');
            $('.main-content-wrapper').removeClass('sidebar-shown');
            if ($(window).width() <= 576) {
                $('body').css('overflow-x', 'auto');
            }
        });

        $(document).click(function (e) {
            if ($(window).width() <= 576 && $('#agent-summary').hasClass('shown')) {
                if (!$(e.target).closest('#agent-summary').length &&
                    !$(e.target).closest('#toggle-agent-summary').length) {
                    $('#agent-summary').removeClass('shown');
                    $('.main-content-wrapper').removeClass('sidebar-shown');
                    $('body').css('overflow-x', 'auto');
                }
            }
        });

        // Show/hide additional content in summary
        $('.show-more-link').click(function () {
            var section = $(this).closest('.summary-item');
            section.find('.additional-content').slideDown();
            $(this).hide();
        });

        $('.show-less-link').click(function () {
            var section = $(this).closest('.summary-item');
            section.find('.additional-content').slideUp();
            section.find('.show-more-link').show();
        });

        // Handle Create New Pinned Note from sidebar - MODIFIED TO ALWAYS SHOW CREATE FORM
        $('#create-pinnednote-from-sidebar').click(function (e) {
            e.preventDefault();
            var notesTabLink = $('a[href="#notes-content"]');
            
            // Always reset to create form when clicking "Create new"
            function showCreateForm() {
                $('#notesMainContent').hide();
                $('#editnoteContainer').hide();
                $('#createNewnoteContainer').show();
                $('#checkboxpin').prop('checked', true);
                
                $('html, body').animate({
                    scrollTop: $('#createNewnoteContainer').offset().top - 20
                }, 300);
            }
            
            if (!$('a[href="#notes-content"]').hasClass('active')) {
                notesTabLink.tab('show');
                notesTabLink.on('shown.bs.tab', function () {
                    showCreateForm();
                    notesTabLink.off('shown.bs.tab');
                });
            } else {
                showCreateForm();
            }
        });

        // Handle existing create note button
        $('#showCreateNoteBtn').click(function (e) {
            e.preventDefault();
            $('#notesMainContent').hide();
            $('#editnoteContainer').hide();
            $('#createNewnoteContainer').show();
            $('#checkboxpin').prop('checked', false);
        });

        // Handle back/cancel buttons
        $('#backToNotesBtn, #cancelNoteBtn').click(function () {
            $('#createNewnoteContainer').hide();
            $('#editnoteContainer').hide();
            $('#notesMainContent').show();
        });

        // Reset form visibility when switching tabs
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.hash !== '#notes-content') {
                $('#createNewnoteContainer').hide();
                $('#editnoteContainer').hide();
                $('#notesMainContent').show();
            }
        });

        // Check URL hash on page load to show form if coming from sidebar
        if (window.location.hash === '#notes-content' && $('#create-pinnednote-from-sidebar').data('show-form')) {
            $('#notesMainContent').hide();
            $('#editnoteContainer').hide();
            $('#createNewnoteContainer').show();
            $('#checkboxpin').prop('checked', true);
        }

            });
    
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle pinned note links
    document.querySelectorAll('.pinned-note-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get the parent summary item which contains all the data attributes
            const summaryItem = this.closest('.summary-item');
            
            // Get all data attributes
            const noteId = this.getAttribute('data-id');
            const subject = this.getAttribute('data-subject');
            const notes = this.getAttribute('data-notes');
            const pinned = this.getAttribute('data-pinned') === 'true';
            const attachmentUrl = this.getAttribute('data-attachment');
            
            // Show the edit container and hide others
            document.getElementById('notesMainContent').style.display = 'none';
            document.getElementById('createNewnoteContainer').style.display = 'none';
            document.getElementById('editnoteContainer').style.display = 'block';
            
            // Populate the form fields
            document.getElementById('editSubject').value = subject || '';
            document.getElementById('editNotes').value = notes || '';
            document.getElementById('editCheckboxpin').checked = pinned;
            document.getElementById('editNoteId').value = noteId;
            
            // Handle attachment preview
            const previewDiv = document.getElementById('edit_note_attachment_preview');
            if (previewDiv) {
                previewDiv.innerHTML = '';
                if (attachmentUrl) {
                    previewDiv.innerHTML = `
                        <div class="attachment-preview">
                            <a href="${attachmentUrl}" target="_blank" class="btn btn-xs btn-default">
                                <i class="fa fa-paperclip"></i> View Attachment
                            </a>
                            <label class="remove-attachment" style="margin-left: 10px; cursor: pointer;">
                                <input type="checkbox" name="remove_attachment"> Remove
                            </label>
                        </div>
                    `;
                }
            }
            
            // Switch to Notes tab if not already active
            if (!$('#notes-content').hasClass('active')) {
                $('a[href="#notes-content"]').tab('show');
            }
            
            // Scroll to the edit section
            $('html, body').animate({
                scrollTop: $('#editnoteContainer').offset().top - 20
            }, 300);
        });
    });
    
    // Handle back button
    document.getElementById('backToEditNotesBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('editnoteContainer').style.display = 'none';
        document.getElementById('notesMainContent').style.display = 'block';
    });
    
    // Handle cancel button
    document.getElementById('cancelEditNoteBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('editnoteContainer').style.display = 'none';
        document.getElementById('notesMainContent').style.display = 'block';
    });
    
   
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle "Create new" button in Activities Due section
    document.getElementById('createActivityBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Switch to Activities tab first
        $('[href="#activities-content"]').tab('show');
        
        // After tab is shown, show the create form
        setTimeout(() => {
            document.getElementById('activityMainContent').style.display = 'none';
            document.getElementById('agencyeditSection').style.display = 'none';
            document.getElementById('createNewactivityContainer').style.display = 'block';
            
            // Scroll to the form section
            $('html, body').animate({
                scrollTop: $('#createNewactivityContainer').offset().top - 20
            }, 300);
        }, 100);
    });
    
    // Existing activity edit link handling
    document.querySelectorAll('.activity-edit-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get all activity data from data attributes
            const activityId = this.getAttribute('data-id');
            const subject = this.getAttribute('data-subject');
            const notes = this.getAttribute('data-notes');
            const status = this.getAttribute('data-status');
            const followUpUser = this.getAttribute('data-follow-up-user');
            const followUpTeam = this.getAttribute('data-follow-up-team');
            const dueDate = this.getAttribute('data-due-date');
            const activityDate = this.getAttribute('data-activity-date');
            const priority = this.getAttribute('data-priority');
            const activityType = this.getAttribute('data-type');
            const method = this.getAttribute('data-method');
            const attachmentUrl = this.getAttribute('data-attachment');
            
            // Switch to Activities tab first
            $('[href="#activities-content"]').tab('show');
            
            // After tab is shown, populate and show the edit form
            setTimeout(() => {
                document.getElementById('activityMainContent').style.display = 'none';
                document.getElementById('createNewactivityContainer').style.display = 'none';
                document.getElementById('agencyeditSection').style.display = 'block';
                
                // Populate form fields
                document.getElementById('edit-subject').value = subject || '';
                document.getElementById('edit-notes').value = notes || '';
                document.getElementById('edit-status').value = status || '';
                document.getElementById('edit-user').value = followUpUser || '';
                document.getElementById('edit-team').value = followUpTeam || '';
                document.getElementById('edit-due-date').value = dueDate || '';
                document.getElementById('edit-activity-date').value = activityDate || '';
                document.getElementById('edit-priority').value = priority || '';
                document.getElementById('edit-type').value = activityType || '';
                document.getElementById('edit-method').value = method || '';
                document.getElementById('edit-activity-id').value = activityId || '';
                
                // Handle attachment preview
                const previewDiv = document.getElementById('edit-attachment-preview');
                if (previewDiv) {
                    previewDiv.innerHTML = '';
                    if (attachmentUrl) {
                        previewDiv.innerHTML = `
                            <div class="attachment-preview">
                                <a href="${attachmentUrl}" target="_blank" class="btn btn-xs btn-default">
                                    <i class="fa fa-paperclip"></i> View Attachment
                                </a>
                                <label class="remove-attachment" style="margin-left: 10px; cursor: pointer;">
                                    <input type="checkbox" name="remove_attachment"> Remove
                                </label>
                            </div>
                        `;
                    }
                }
                
                // Scroll to the edit section
                $('html, body').animate({
                    scrollTop: $('#agencyeditSection').offset().top - 20
                }, 300);
            }, 100);
        });
    });
    
    // Handle cancel button
    document.getElementById('closeActivityEdit')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('agencyeditSection').style.display = 'none';
        document.getElementById('activityMainContent').style.display = 'block';
    });
    
   
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab persistence functionality
    const tabLinks = document.querySelectorAll('.nav-tab-btn, .dropdown-item[data-toggle="tab"]');
    const urlParams = new URLSearchParams(window.location.search);
    const initialTabParam = urlParams.get('tab');
    const hashTab = window.location.hash;
    
    // Function to set active tab
    function setActiveTab(tabId) {
        if (!tabId) return;
        
        // Remove active class from all tabs and panes
        tabLinks.forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        
        // Add active class to selected tab and pane
        const tabLink = document.querySelector(`a[href="${tabId}"]`);
        if (tabLink) {
            tabLink.classList.add('active');
            const tabPane = document.querySelector(tabId);
            if (tabPane) {
                tabPane.classList.add('active');
                
                // If this is a dropdown item, also activate its parent dropdown button
                const dropdownItem = tabLink.closest('.dropdown-item');
                if (dropdownItem) {
                    const dropdownToggle = dropdownItem.closest('.dropdown').querySelector('.dropdown-toggle');
                    if (dropdownToggle) {
                        dropdownToggle.classList.add('active');
                    }
                }
            }
        }
    }
    
    // Priority order for tab selection:
    // 1. If coming from search (tab=detail in URL), force detail tab
    // 2. Otherwise, check localStorage for saved tab
    // 3. Fall back to URL hash
    // 4. Finally, default to detail tab
    
    if (initialTabParam === 'detail') {
        // Force detail tab when coming from search
        setActiveTab('#detail-content');
        localStorage.setItem('activeAgentTab', '#detail-content');
        // Clear the parameter so it doesn't affect future tab switches
        const cleanUrl = window.location.pathname + window.location.hash;
        history.replaceState(null, '', cleanUrl);
    } else {
        // Check localStorage for saved tab
        const savedTab = localStorage.getItem('activeAgentTab');
        if (savedTab && document.querySelector(savedTab)) {
            setActiveTab(savedTab);
        } else if (hashTab && document.querySelector(hashTab)) {
            // Use the hash from URL if it matches a tab
            setActiveTab(hashTab);
            localStorage.setItem('activeAgentTab', hashTab);
        } else {
            // Default to detail tab
            setActiveTab('#detail-content');
        }
    }
    
    // Save tab selection when tabs are changed
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const tabId = this.getAttribute('href');
            if (tabId) {
                localStorage.setItem('activeAgentTab', tabId);
                // Update URL hash without adding to history
                history.replaceState(null, null, tabId);
            }
        });
    });
    
    // Handle bootstrap tab events to ensure proper synchronization
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        const tabId = $(e.target).attr('href');
        if (tabId) {
            localStorage.setItem('activeAgentTab', tabId);
            // Update URL hash without adding to history
            history.replaceState(null, null, tabId);
        }
    });
});
</script>
{% endblock %}